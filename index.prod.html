<!DOCTYPE html>
<html lang="en">
<head>
    <script src="https://tinylytics.app/embed/ns_vfdSwLNzVoBs3dz3J.js" defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Rivian Spotter - Find Rivian Spaces & Outposts</title>
    <meta name="description" content="Interactive map of all Rivian Spaces and Demo Centers across the United States. Find locations, hours, and services.">
    
    <!-- Mapbox CSS -->
    <link href='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.css' rel='stylesheet' />

    <!-- Font Optimization -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="preload" href="https://fonts.gstatic.com/s/inter/v13/UcCO3FwrK3iLTeHAPUlGe_ThNYzL-qWIW8DFQIAgicVw.woff2" as="font" type="font/woff2" crossorigin>
    
    <!-- Main Stylesheet -->
    <link rel="stylesheet" href="css/style.min.css">
    

    <meta name="build-version" content="production">
</head>
<body>
    <div class="container">
        <!-- Header will be injected by components.js -->
        
        <div class="map-container">
            <!-- Mobile Overlay -->
            <div class="mobile-overlay" id="mobileOverlay"></div>
            
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <span class="sidebar-title">Filter Locations</span>
                    <button class="close-sidebar" id="closeSidebar">Ã—</button>
                </div>

                <div class="search-box">
                    <input
                        type="text"
                        class="search-input"
                        id="searchInput"
                        placeholder="Search by city, state, or name..."
                    />
                </div>

                <div class="filter-buttons">
                    <button class="filter-btn active" data-filter="all">All</button>
                    <button class="filter-btn" data-filter="Space">Spaces</button>
                    <button class="filter-btn" data-filter="Demo Center">Demo Centers</button>
                    <button class="filter-btn" data-filter="Outpost">Outposts</button>
                    <button class="filter-btn" id="favoritesFilterBtn" disabled>
                        My Favorites
                        <span class="badge" id="favoritesCountBadge" style="display: none;">0</span>
                    </button>
                </div>

                <!-- Recent Locations Section -->
                <div class="recent-locations-section">
                    <div class="section-header">
                        <span class="section-title">Recent Locations</span>
                        <button class="clear-btn" id="clearRecentBtn" title="Clear recent locations">Clear</button>
                    </div>
                    <div class="recent-locations-list" id="recentLocationsList">
                        <!-- Recent locations will be inserted here -->
                    </div>
                </div>

                <!-- Export/Import Actions -->
                <div class="actions-section">
                    <div class="section-header">
                        <span class="section-title">Actions</span>
                    </div>
                    <div class="action-buttons">
                        <button class="action-btn" id="exportCSVBtn" title="Export all locations to CSV">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                            Export CSV
                        </button>
                        <button class="action-btn" id="exportJSONBtn" title="Export all locations to JSON">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                                <path d="M19 9h-4V3H9v6H5l7 7 7-7zM5 18v2h14v-2H5z"/>
                            </svg>
                            Export JSON
                        </button>
                        <button class="action-btn" id="printAllBtn" title="Print all locations">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                                <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                            </svg>
                            Print All
                        </button>
                        <button class="action-btn" id="exportFavoritesBtn" title="Export favorites">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                            Export Favorites
                        </button>
                        <button class="action-btn" id="importFavoritesBtn" title="Import favorites">
                            <svg viewBox="0 0 24 24" fill="currentColor" style="width: 16px; height: 16px;">
                                <path d="M9 16h6v-6h4l-7-7-7 7h4zm-4 2h14v2H5z"/>
                            </svg>
                            Import Favorites
                        </button>
                        <input type="file" id="importFavoritesInput" accept=".json" style="display: none;" />
                    </div>
                </div>

                <!-- Advanced Filters Toggle -->
                <div class="advanced-filters-toggle">
                    <button class="toggle-filters-btn" id="toggleAdvancedFilters">
                        <span>Advanced Filters</span>
                        <span class="filter-badge" id="activeFilterBadge" style="display: none;">0</span>
                        <svg class="toggle-icon" id="toggleIcon" viewBox="0 0 24 24" width="20" height="20">
                            <path d="M7 10l5 5 5-5z"/>
                        </svg>
                    </button>
                </div>

                <!-- Advanced Filters Panel -->
                <div class="advanced-filters-panel" id="advancedFiltersPanel" style="display: none;">
                    <!-- Multi-select State Filter -->
                    <div class="filter-section">
                        <div class="filter-section-header">
                            <label class="filter-section-label">States/Provinces</label>
                            <div class="filter-section-actions">
                                <button class="filter-action-btn" id="selectAllStates">Select All</button>
                                <button class="filter-action-btn" id="clearAllStates">Clear</button>
                            </div>
                        </div>
                        <div class="state-checkboxes" id="stateCheckboxes">
                            <!-- State checkboxes will be inserted here -->
                        </div>
                    </div>

                    <!-- Services Filter -->
                    <div class="filter-section">
                        <label class="filter-section-label">Services Offered</label>
                        <div class="service-checkboxes" id="serviceCheckboxes">
                            <!-- Service checkboxes will be inserted here -->
                        </div>
                    </div>

                    <!-- Opening Date Range Filter -->
                    <div class="filter-section">
                        <label class="filter-section-label">Opening Date</label>
                        <div class="date-filter-controls">
                            <div class="date-filter-group">
                                <label class="date-filter-label">From:</label>
                                <input type="date" class="date-filter-input" id="dateFrom" />
                            </div>
                            <div class="date-filter-group">
                                <label class="date-filter-label">To:</label>
                                <input type="date" class="date-filter-input" id="dateTo" />
                            </div>
                            <div class="date-filter-presets">
                                <button class="preset-btn" data-preset="opening-soon">Opening Soon</button>
                                <button class="preset-btn" data-preset="recently-opened">Recently Opened</button>
                            </div>
                        </div>
                    </div>

                    <!-- Distance Filter -->
                    <div class="filter-section">
                        <label class="filter-section-label">Distance From Me</label>
                        <div class="distance-filter-controls">
                            <button class="enable-distance-btn" id="enableDistanceFilter">
                                Enable Location
                            </button>
                            <div class="distance-slider-container" id="distanceSliderContainer" style="display: none;">
                                <div class="distance-value-display">
                                    <span id="distanceValue">50</span> miles
                                </div>
                                <input
                                    type="range"
                                    class="distance-slider"
                                    id="distanceSlider"
                                    min="10"
                                    max="500"
                                    value="50"
                                    step="5"
                                />
                                <div class="distance-labels">
                                    <span>10</span>
                                    <span>100</span>
                                    <span>500 mi</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Clear All Filters -->
                    <div class="filter-section">
                        <button class="clear-all-filters-btn" id="clearAllFilters">
                            Clear All Filters
                        </button>
                    </div>
                </div>

                <div class="location-stats" id="locationStats">
                    <!-- Stats will be inserted here -->
                </div>

                <div class="location-list" id="locationList">
                    <!-- Locations will be inserted here -->
                </div>
            </div>
            
            <div id="map"></div>
            
            <!-- Current Location Button -->
            <button class="location-btn" id="locationBtn" title="Go to my location">
                <svg viewBox="0 0 24 24">
                    <path d="M12 8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4zm8.94 3c-.46-4.17-3.77-7.48-7.94-7.94V1h-2v2.06C6.83 3.52 3.52 6.83 3.06 11H1v2h2.06c.46 4.17 3.77 7.48 7.94 7.94V23h2v-2.06c4.17-.46 7.48-3.77 7.94-7.94H23v-2h-2.06zM12 19c-3.87 0-7-3.13-7-7s3.13-7 7-7 7 3.13 7 7-3.13 7-7 7z"/>
                </svg>
            </button>
            
            <!-- Mobile Bottom Bar -->
            <div class="mobile-bottom-bar" id="mobileBottomBar">
                <button id="mobileFilterBtn">Filter</button>
                <button id="mobileListBtn">List</button>
                <button id="mobileNearMeBtn">Near Me</button>
            </div>
        </div>
    </div>

    <!-- Feature Notification -->
    <div class="feature-notification" id="featureNotification"></div>

    <!-- Load Components First -->
    <script src="js/components.min.js"></script>

    <!-- Mapbox GL JS -->
    <script src='https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js'></script>

    <!-- Configuration -->
    <script src="js/config.min.js"></script>

    <!-- Data Loader -->
    <script src="js/data-loader.min.js"></script>

    <!-- Location Data -->
    <script src="js/locations.js?v=20250926d"></script>


    <!-- Configuration and Main Application -->
    <script>
        // Initialize Mapbox (should be moved to environment variables in production)
        mapboxgl.accessToken = 'pk.eyJ1IjoiemFrd2lubmljayIsImEiOiJjbWYxYzV5bmQxZGwzMmxxNHBieHp3NDI2In0.YAzo3vcGSqaNxZyz4GA7xg';
    </script>

    <!-- Main Application Logic -->
    <script src="js/app.min.js"></script>

    <!-- User Features (Favorites, Sharing, Export, Recent) -->
    <script src="js/features.min.js"></script>

    <!-- Service Worker Registration -->
    <script>
        // Register Service Worker for offline support
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered successfully:', registration.scope);

                        // Check for updates
                        registration.addEventListener('updatefound', () => {
                            const newWorker = registration.installing;
                            newWorker.addEventListener('statechange', () => {
                                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                                    // New service worker available
                                    console.log('New service worker available - refresh to update');

                                    // Optionally show a notification to the user
                                    if (confirm('A new version of Rivian Spotter is available. Reload to update?')) {
                                        newWorker.postMessage({ type: 'SKIP_WAITING' });
                                        window.location.reload();
                                    }
                                }
                            });
                        });
                    })
                    .catch(error => {
                        console.error('Service Worker registration failed:', error);
                    });

                // Listen for service worker messages
                navigator.serviceWorker.addEventListener('message', (event) => {
                    if (event.data.type === 'SYNC_COMPLETE') {
                        console.log('Background sync complete:', event.data.syncedCount, 'changes synced');
                    }
                });

                // Handle controller change (new service worker activated)
                navigator.serviceWorker.addEventListener('controllerchange', () => {
                    console.log('Service Worker controller changed - reloading page');
                    window.location.reload();
                });
            });
        }
    </script>
</body>
</html>