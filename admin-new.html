<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - Rivian Spotter</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="css/style.css">
    <style>
        .admin-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 2rem;
        }
        
        .admin-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 2rem;
        }
        
        .admin-title {
            font-size: 2rem;
            font-weight: 700;
        }
        
        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 6px;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        
        .btn:hover {
            opacity: 0.9;
        }
        
        .btn-primary {
            background: #4CAF50;
            color: white;
        }
        
        .btn-danger {
            background: #f44336;
            color: white;
        }
        
        .btn-secondary {
            background: #666;
            color: white;
        }
        
        .locations-grid {
            display: grid;
            gap: 1rem;
            margin-bottom: 2rem;
        }
        
        .location-item {
            background: white;
            border: 1px solid #e5e5e5;
            border-radius: 8px;
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .location-item.modified {
            background: #fffbf0;
            border-color: #ffa726;
        }
        
        .changes-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: #333;
            color: white;
            padding: 1rem 2rem;
            display: none;
            align-items: center;
            justify-content: space-between;
            z-index: 999;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.2);
        }
        
        .changes-bar.active {
            display: flex;
        }
        
        .changes-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .changes-count {
            background: #ffa726;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-weight: 600;
        }
        
        .changes-actions {
            display: flex;
            gap: 1rem;
        }
        
        .location-info {
            flex: 1;
        }
        
        .location-actions {
            display: flex;
            gap: 0.5rem;
        }
        
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
        }
        
        .form-group {
            margin-bottom: 1rem;
        }
        
        .form-label {
            display: block;
            margin-bottom: 0.25rem;
            font-weight: 500;
            font-size: 0.9rem;
        }
        
        .form-input, .form-select {
            width: 100%;
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        
        .form-actions {
            display: flex;
            gap: 1rem;
            justify-content: flex-end;
            margin-top: 1.5rem;
        }
        
        .stats-bar {
            background: #f8f8f8;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 2rem;
            display: flex;
            gap: 2rem;
        }
        
        .stat {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .stat-value {
            font-weight: 600;
            color: #4CAF50;
        }
        
        .search-bar {
            margin-bottom: 1rem;
        }
        
        .search-input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 1rem;
        }
        
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <header class="header">
            <a href="/" class="logo">
                <div class="logo-dot"></div>
                Rivian Spotter Admin
            </a>
            <nav class="nav-links">
                <a href="/" class="nav-link">← Back to Site</a>
                <button class="btn btn-danger" onclick="logout()">Logout</button>
            </nav>
        </header>
        
        <div class="admin-container">
            <div class="admin-header">
                <h1 class="admin-title">Location Manager</h1>
                <button class="btn btn-primary" onclick="openModal()">+ Add Location</button>
            </div>
            
            <div class="stats-bar">
                <div class="stat">
                    <span>Total:</span>
                    <span class="stat-value" id="totalCount">0</span>
                </div>
                <div class="stat">
                    <span>Spaces:</span>
                    <span class="stat-value" id="spacesCount">0</span>
                </div>
                <div class="stat">
                    <span>Outposts:</span>
                    <span class="stat-value" id="outpostsCount">0</span>
                </div>
                <div class="stat">
                    <span>States:</span>
                    <span class="stat-value" id="statesCount">0</span>
                </div>
            </div>
            
            <div class="search-bar">
                <input type="text" class="search-input" id="searchInput" placeholder="Search locations...">
            </div>
            
            <div class="locations-grid" id="locationsList">
                <!-- Locations will be loaded here -->
            </div>
        </div>
    </div>
    
    <!-- Changes Bar -->
    <div class="changes-bar" id="changesBar">
        <div class="changes-info">
            <span>You have unsaved changes</span>
            <span class="changes-count" id="changesCount">0</span>
        </div>
        <div class="changes-actions">
            <button class="btn btn-secondary" onclick="discardChanges()">Discard Changes</button>
            <button class="btn btn-primary" onclick="saveAllChanges()">Save All Changes</button>
        </div>
    </div>
    
    <!-- Edit/Add Modal -->
    <div class="modal" id="locationModal">
        <div class="modal-content">
            <h2 id="modalTitle">Add Location</h2>
            <form id="locationForm">
                <input type="hidden" id="locationId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Name*</label>
                        <input type="text" class="form-input" id="name" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Type*</label>
                        <select class="form-select" id="type" required>
                            <option value="Space">Space</option>
                            <option value="Outpost">Outpost</option>
                        </select>
                    </div>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Latitude*</label>
                        <input type="number" step="0.0001" class="form-input" id="lat" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Longitude*</label>
                        <input type="number" step="0.0001" class="form-input" id="lng" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Address*</label>
                    <input type="text" class="form-input" id="address" required>
                </div>
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">City*</label>
                        <input type="text" class="form-input" id="city" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">State*</label>
                        <input type="text" class="form-input" id="state" maxlength="2" placeholder="CA" required>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Hours</label>
                    <input type="text" class="form-input" id="hours" placeholder="Mon-Sat: 10am-7pm, Sun: 11am-6pm">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Phone</label>
                    <input type="text" class="form-input" id="phone" placeholder="(555) 123-4567">
                </div>
                
                <div class="form-group">
                    <label class="form-label">Services (comma-separated)</label>
                    <input type="text" class="form-input" id="services" placeholder="Test Drives, Vehicle Tours, Merchandise">
                </div>
                
                <div class="form-group">
                    <div class="checkbox-group">
                        <input type="checkbox" id="isOpen" checked>
                        <label for="isOpen">Location is currently open</label>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeModal()">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Location</button>
                </div>
            </form>
        </div>
    </div>
    
    <script>
        // Simple authentication (in production, use proper auth)
        const ADMIN_PASSWORD = 'rivian2024'; // Change this!
        let locations = [];
        let originalLocations = []; // Keep original for comparison
        let editingId = null;
        let pendingChanges = new Map(); // Track changes
        
        // Check authentication
        function checkAuth() {
            const auth = localStorage.getItem('rivianAdminAuth');
            if (!auth) {
                const password = prompt('Enter admin password:');
                if (password === ADMIN_PASSWORD) {
                    localStorage.setItem('rivianAdminAuth', 'true');
                } else {
                    alert('Invalid password');
                    window.location.href = '/';
                }
            }
        }
        
        function logout() {
            localStorage.removeItem('rivianAdminAuth');
            window.location.href = '/';
        }
        
        // Load locations
        async function loadLocations() {
            try {
                // For now, load from the JS file
                // Later this will load from your API
                const script = document.createElement('script');
                script.src = '/js/locations.js';
                script.onload = () => {
                    locations = [...rivianLocations];
                    originalLocations = JSON.parse(JSON.stringify(rivianLocations)); // Deep copy
                    renderLocations();
                    updateStats();
                };
                document.head.appendChild(script);
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }
        
        // Render locations list
        function renderLocations(searchTerm = '') {
            const container = document.getElementById('locationsList');
            
            const filtered = locations.filter(loc => 
                searchTerm === '' || 
                loc.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                loc.city.toLowerCase().includes(searchTerm.toLowerCase()) ||
                loc.state.toLowerCase().includes(searchTerm.toLowerCase())
            );
            
            container.innerHTML = filtered.map(location => {
                const isModified = pendingChanges.has(location.id);
                return `
                    <div class="location-item ${isModified ? 'modified' : ''}">
                        <div class="location-info">
                            <strong>${location.name}</strong> - ${location.type}
                            <br>
                            <small style="color: #666;">${location.address}, ${location.city}</small>
                            ${location.isOpen === false ? '<span style="color: red; margin-left: 1rem;">CLOSED</span>' : ''}
                            ${isModified ? '<span style="color: #ffa726; margin-left: 1rem;">• Modified</span>' : ''}
                        </div>
                        <div class="location-actions">
                            <button class="btn btn-secondary" onclick="editLocation(${location.id})">Edit</button>
                            <button class="btn btn-danger" onclick="deleteLocation(${location.id})">Delete</button>
                        </div>
                    </div>
                `;
            }).join('');
        }
        
        // Update stats
        function updateStats() {
            document.getElementById('totalCount').textContent = locations.length;
            document.getElementById('spacesCount').textContent = locations.filter(l => l.type === 'Space').length;
            document.getElementById('outpostsCount').textContent = locations.filter(l => l.type === 'Outpost').length;
            document.getElementById('statesCount').textContent = [...new Set(locations.map(l => l.state))].length;
        }
        
        // Track changes
        function trackChange(locationId, action = 'modified') {
            pendingChanges.set(locationId, action);
            updateChangesBar();
            renderLocations(document.getElementById('searchInput').value);
        }
        
        // Update changes bar
        function updateChangesBar() {
            const changesBar = document.getElementById('changesBar');
            const changesCount = document.getElementById('changesCount');
            
            if (pendingChanges.size > 0) {
                changesBar.classList.add('active');
                changesCount.textContent = pendingChanges.size;
            } else {
                changesBar.classList.remove('active');
            }
        }
        
        // Save all changes
        function saveAllChanges() {
            if (pendingChanges.size === 0) {
                alert('No changes to save');
                return;
            }
            
            const changesCount = pendingChanges.size;
            
            // Create downloadable file
            const dataStr = `const rivianLocations = ${JSON.stringify(locations, null, 2)};
if (typeof module !== 'undefined' && module.exports) {
    module.exports = rivianLocations;
}`;
            
            const blob = new Blob([dataStr], { type: 'text/javascript' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'locations.js';
            a.click();
            
            // Clear pending changes
            pendingChanges.clear();
            originalLocations = JSON.parse(JSON.stringify(locations));
            updateChangesBar();
            renderLocations(document.getElementById('searchInput').value);
            
            alert(`${changesCount} changes saved! Upload the downloaded locations.js file to your server.`);
        }
        
        // Discard all changes
        function discardChanges() {
            if (pendingChanges.size === 0) return;
            
            if (confirm(`Discard ${pendingChanges.size} unsaved changes?`)) {
                locations = JSON.parse(JSON.stringify(originalLocations));
                pendingChanges.clear();
                updateChangesBar();
                renderLocations(document.getElementById('searchInput').value);
            }
        }
        
        // Modal functions
        function openModal(id = null) {
            editingId = id;
            document.getElementById('locationModal').classList.add('active');
            
            if (id) {
                const location = locations.find(l => l.id === id);
                document.getElementById('modalTitle').textContent = 'Edit Location';
                document.getElementById('locationId').value = location.id;
                document.getElementById('name').value = location.name;
                document.getElementById('type').value = location.type;
                document.getElementById('lat').value = location.lat;
                document.getElementById('lng').value = location.lng;
                document.getElementById('address').value = location.address;
                document.getElementById('city').value = location.city;
                document.getElementById('state').value = location.state;
                document.getElementById('hours').value = location.hours || '';
                document.getElementById('phone').value = location.phone || '';
                document.getElementById('services').value = (location.services || []).join(', ');
                document.getElementById('isOpen').checked = location.isOpen !== false;
            } else {
                document.getElementById('modalTitle').textContent = 'Add Location';
                document.getElementById('locationForm').reset();
            }
        }
        
        function closeModal() {
            document.getElementById('locationModal').classList.remove('active');
            editingId = null;
        }
        
        function editLocation(id) {
            openModal(id);
        }
        
        function deleteLocation(id) {
            if (confirm('Are you sure you want to delete this location?')) {
                locations = locations.filter(l => l.id !== id);
                trackChange(id, 'deleted');
                renderLocations(document.getElementById('searchInput').value);
                updateStats();
            }
        }
        
        // Form submission
        document.getElementById('locationForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const formData = {
                id: editingId || Date.now(),
                name: document.getElementById('name').value,
                type: document.getElementById('type').value,
                lat: parseFloat(document.getElementById('lat').value),
                lng: parseFloat(document.getElementById('lng').value),
                address: document.getElementById('address').value,
                city: document.getElementById('city').value,
                state: document.getElementById('state').value.toUpperCase(),
                hours: document.getElementById('hours').value,
                phone: document.getElementById('phone').value,
                services: document.getElementById('services').value.split(',').map(s => s.trim()).filter(s => s),
                isOpen: document.getElementById('isOpen').checked
            };
            
            if (editingId) {
                const index = locations.findIndex(l => l.id === editingId);
                locations[index] = formData;
                trackChange(editingId, 'modified');
            } else {
                locations.push(formData);
                trackChange(formData.id, 'added');
            }
            
            renderLocations(document.getElementById('searchInput').value);
            updateStats();
            closeModal();
        });
        
        // Search
        document.getElementById('searchInput').addEventListener('input', function(e) {
            renderLocations(e.target.value);
        });
        
        // Keyboard shortcuts
        document.addEventListener('keydown', function(e) {
            // Ctrl/Cmd + S to save
            if ((e.ctrlKey || e.metaKey) && e.key === 's') {
                e.preventDefault();
                saveAllChanges();
            }
            // Escape to close modal
            if (e.key === 'Escape') {
                closeModal();
            }
        });
        
        // Warn before leaving with unsaved changes
        window.addEventListener('beforeunload', function(e) {
            if (pendingChanges.size > 0) {
                e.preventDefault();
                e.returnValue = 'You have unsaved changes. Are you sure you want to leave?';
            }
        });
        
        // Initialize
        checkAuth();
        loadLocations();
    </script>
</body>
</html>
